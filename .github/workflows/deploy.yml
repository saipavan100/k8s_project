name: CI/CD - Build & Deploy to Kubernetes

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  ACR_REGISTRY: ${{ secrets.ACR_NAME }}.azurecr.io
  IMAGE_NAME_BACKEND: myapp-backend
  IMAGE_NAME_FRONTEND: myapp-frontend
  NAMESPACE: winonboard
  RELEASE_NAME: myapp

jobs:
  build-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_NAME }}.azurecr.io
          username: ${{ secrets.ACR_NAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push backend image
        run: |
          docker build -t ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ github.sha }} ./backend
          docker tag ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ github.sha }} ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest
          docker push ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ github.sha }}
          docker push ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest

  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_NAME }}.azurecr.io
          username: ${{ secrets.ACR_NAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push frontend image
        run: |
          docker build -t ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.sha }} ./frontend
          docker tag ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.sha }} ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:latest
          docker push ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.sha }}
          docker push ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:latest

  deploy-helm:
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Configure kubectl
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBECONFIG }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_CONTENT" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          kubectl cluster-info

      - name: Create namespace
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Create ACR pull secret
        run: |
          kubectl create secret docker-registry acr-secret \
            --docker-server=${{ env.ACR_REGISTRY }} \
            --docker-username=${{ secrets.ACR_NAME }} \
            --docker-password=${{ secrets.ACR_PASSWORD }} \
            -n ${{ env.NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Generate values-prod.yaml from GitHub secrets
        run: |
          cat > /tmp/values-prod.yaml <<'EOF'
          backend_secrets:
            MONGODB_URI: "${{ secrets.MONGODB_URI }}"
            JWT_SECRET: "${{ secrets.JWT_SECRET }}"
            JWT_EXPIRE: "${{ secrets.JWT_EXPIRE }}"
            EMAIL_HOST: "${{ secrets.EMAIL_HOST }}"
            EMAIL_PORT: "${{ secrets.EMAIL_PORT }}"
            EMAIL_USER: "${{ secrets.EMAIL_USER }}"
            EMAIL_PASSWORD: "${{ secrets.EMAIL_PASSWORD }}"
            EMAIL_FROM: "${{ secrets.EMAIL_FROM }}"
            ADMIN_EMAIL: "${{ secrets.ADMIN_EMAIL }}"
            ADMIN_PASSWORD: "${{ secrets.ADMIN_PASSWORD }}"
            AZURE_OPENAI_ENDPOINT: "${{ secrets.AZURE_OPENAI_ENDPOINT }}"
            AZURE_OPENAI_API_KEY: "${{ secrets.AZURE_OPENAI_API_KEY }}"
          EOF

      - name: Deploy with Helm (upgrade or install)
        run: |
          helm upgrade --install ${{ env.RELEASE_NAME }} ./win_k8s \
            -n ${{ env.NAMESPACE }} \
            -f win_k8s/values-template.yaml \
            -f /tmp/values-prod.yaml \
            --set backend.tag=latest \
            --set frontend.tag=latest \
            --wait \
            --timeout 5m

      - name: Verify deployment
        run: |
          echo "=== Checking Pod Status ==="
          kubectl get pods -n ${{ env.NAMESPACE }}
          
          echo "=== Checking Services ==="
          kubectl get svc -n ${{ env.NAMESPACE }}
          
          echo "=== Checking Ingress ==="
          kubectl get ingress -n ${{ env.NAMESPACE }}
          
          echo "=== Rollout Status ==="
          kubectl rollout status deployment/${{ env.RELEASE_NAME }}-backend -n ${{ env.NAMESPACE }} --timeout=3m || true
          kubectl rollout status deployment/${{ env.RELEASE_NAME }}-frontend -n ${{ env.NAMESPACE }} --timeout=3m || true
